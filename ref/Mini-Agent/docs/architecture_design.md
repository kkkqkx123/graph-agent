# Mini-Agent 架构设计文档

## 1. 项目概述

Mini-Agent 是一个极简但专业的智能代理演示项目，展示了使用 MiniMax M2 模型构建代理的最佳实践。该项目利用与 Anthropic 兼容的 API，完全支持交错思维，以解锁 M2 在长而复杂任务中的强大推理能力。

## 2. 核心特性

- ✅ **完整的代理执行循环**: 提供可靠的基础架构和基本工具集，用于文件系统和 shell 操作
- ✅ **持久化记忆**: 活跃的会话笔记工具确保代理在多个会话中保留关键信息
- ✅ **智能上下文管理**: 自动摘要对话历史，处理可配置令牌限制的上下文，支持无限长的任务
- ✅ **Claude 技能集成**: 包含 15 种专业技能，涵盖文档、设计、测试和开发
- ✅ **MCP 工具集成**: 原生支持 MCP 工具，如知识图谱访问和网络搜索
- ✅ **全面日志记录**: 详细记录每个请求、响应和工具执行，便于调试
- ✅ **简洁优雅的设计**: 美丽的命令行界面和易于理解的代码库

## 3. 整体架构

Mini-Agent 采用模块化设计，主要分为以下几个层次：

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI 层                               │
│              (命令行交互和用户界面)                           │
├─────────────────────────────────────────────────────────────┤
│                       应用层                                 │
│              (Agent 实例化和运行逻辑)                         │
├─────────────────────────────────────────────────────────────┤
│                      服务层                                  │
│         (LLM 客户端、工具管理、消息处理)                       │
├─────────────────────────────────────────────────────────────┤
│                     配置层                                   │
│              (配置加载和管理)                                │
├─────────────────────────────────────────────────────────────┤
│                     工具层                                   │
│         (文件操作、Bash 执行、笔记、技能、MCP)                │
└─────────────────────────────────────────────────────────────┘
```

## 4. 模块架构详解

### 4.1 CLI 模块 (cli.py)
- 负责命令行参数解析
- 提供交互式会话界面
- 使用 prompt_toolkit 实现高级终端功能
- 支持命令历史、自动补全和快捷键

### 4.2 Agent 模块 (agent.py)
- 核心代理执行逻辑
- 管理消息历史和上下文长度
- 实现智能摘要机制防止上下文溢出
- 控制代理执行循环和工具调用流程

### 4.3 LLM 客户端模块 (llm.py)
- 与 MiniMax M2 模型的接口
- 通过 Anthropic 兼容 API 进行通信
- 处理模型请求和响应格式转换
- 支持工具调用和思维链功能

### 4.4 配置模块 (config.py)
- 统一配置管理
- 支持 YAML 格式配置文件
- 配置优先级搜索机制
- 包含 LLM、代理和工具的配置选项

### 4.5 工具模块 (tools/)
- 基础工具抽象类定义
- 文件操作工具 (读、写、编辑)
- Bash 命令执行工具 (支持后台进程)
- 会话笔记工具 (持久化记忆)
- Claude 技能加载器和工具
- MCP (Model Context Protocol) 工具集成

### 4.6 模式定义 (schema/)
- 定义数据传输对象 (DTO)
- 包括消息、工具调用、函数调用等结构
- 使用 Pydantic 进行数据验证

### 4.7 日志模块 (logger.py)
- 记录代理运行过程
- 保存 LLM 请求和响应
- 记录工具执行结果
- 生成详细的运行日志

### 4.8 重试机制 (retry.py)
- 异步函数重试装饰器
- 指数退避策略
- 可配置的重试次数和延迟
- 详细的错误处理和日志记录

## 5. 数据流

```
用户输入 → CLI 解析 → Agent 处理 → LLM 调用 → 工具执行 → 结果返回 → 用户输出
```

## 6. 关键设计模式

### 6.1 工具抽象模式
所有工具都继承自基础 `Tool` 类，提供统一的接口：
- `name`: 工具名称
- `description`: 工具描述
- `parameters`: 参数模式定义
- `execute`: 执行方法

### 6.2 配置优先级搜索
配置文件按以下优先级顺序查找：
1. 当前目录的 mini_agent/config/
2. 用户主目录的 ~/.mini-agent/config/
3. 包安装目录的 config/

### 6.3 渐进式信息披露
对于 Claude 技能，采用三级渐进式信息披露：
- 第一级：在系统提示中仅包含技能元数据（名称和描述）
- 第二级：按需加载完整技能内容
- 第三级：将相对路径转换为绝对路径

### 6.4 上下文管理
当消息历史接近令牌限制时，自动触发摘要机制：
- 保留所有用户消息
- 总结助手执行过程
- 保持上下文连贯性

## 7. 扩展性设计

### 7.1 工具扩展
通过继承 `Tool` 基类可以轻松添加新工具，系统会自动注册并提供给 LLM。

### 7.2 技能扩展
通过在技能目录中添加新的 SKILL.md 文件即可扩展 Claude 技能。

### 7.3 MCP 工具扩展
通过在 MCP 配置文件中添加新的服务器定义即可集成外部工具。

## 8. 错误处理

- LLM 调用失败时的重试机制
- 工具执行异常捕获和报告
- 配置文件缺失或格式错误的处理
- 文件操作权限和存在性检查

## 9. 性能优化

- 智能上下文摘要防止令牌溢出
- 大文件内容的令牌限制截断
- 后台进程管理避免资源泄漏
- 高效的异步 I/O 操作

## 10. 安全考虑

- API 密钥安全存储和传输
- 文件路径规范化防止路径遍历攻击
- 输入验证和清理
- 工具执行沙箱化考虑