# Mini-Agent 模块功能说明文档

## 1. Agent 模块 (agent.py)

Agent 模块是 Mini-Agent 的核心执行引擎，负责协调整个代理的工作流程。

### 主要功能
- **消息历史管理**: 维护完整的对话历史，包括用户输入、助手回复和工具执行结果
- **上下文长度控制**: 使用 tiktoken 准确计算令牌数量，防止超出模型上下文限制
- **智能摘要机制**: 当令牌数量超过预设限制时，自动摘要历史对话内容，保留用户输入并压缩助手执行过程
- **执行循环控制**: 管理代理的多步骤执行过程，直到任务完成或达到最大步数限制
- **工具调用协调**: 接收 LLM 的工具调用指令，执行相应工具并将结果反馈给 LLM
- **日志记录**: 与 Logger 模块协作，记录完整的执行过程

### 关键特性
- 支持多轮对话和复杂任务执行
- 自动上下文管理，支持长时间运行的任务
- 彩色终端输出，提升用户体验
- 详细的执行统计信息

## 2. LLM 客户端模块 (llm.py)

LLM 客户端模块负责与 MiniMax M2 模型进行通信。

### 主要功能
- **API 通信**: 通过 Anthropic 兼容的 API 与 MiniMax M2 模型交互
- **消息格式转换**: 将内部消息格式转换为 Anthropic API 格式
- **工具模式支持**: 支持工具调用和结果处理
- **思维链处理**: 支持 Anthropic 的 thinking 功能
- **错误处理**: 处理 API 错误和模型响应异常
- **重试机制集成**: 与重试模块协作，提高 API 调用的可靠性

### 关键特性
- 支持 Anthropic 格式的工具调用
- 自动处理 thinking 和 tool_use 内容块
- 与 MiniMax 平台的错误码兼容

## 3. 配置模块 (config.py)

配置模块提供统一的配置管理功能。

### 主要功能
- **配置加载**: 从 YAML 文件加载配置
- **优先级搜索**: 按优先级顺序搜索配置文件位置
- **数据验证**: 使用 Pydantic 验证配置数据的有效性
- **默认值设置**: 为未指定的配置项提供合理的默认值

### 配置类别
- **LLM 配置**: API 密钥、API 基地址、模型名称、重试设置
- **代理配置**: 最大步数、工作空间目录、系统提示路径
- **工具配置**: 启用/禁用各类工具、技能目录、MCP 配置路径

### 配置搜索路径
1. 当前目录的 mini_agent/config/
2. 用户主目录的 ~/.mini-agent/config/
3. 包安装目录的 config/

## 4. 工具模块 (tools/)

工具模块提供了代理可用的各种工具。

### 4.1 基础工具类 (base.py)
- **ToolResult**: 工具执行结果的数据结构
- **Tool**: 所有工具的基类，定义统一接口

### 4.2 文件操作工具 (file_tools.py)
- **ReadTool**: 读取文件内容，支持行号显示和部分读取
- **WriteTool**: 写入文件内容，支持创建目录
- **EditTool**: 编辑文件内容，支持精确字符串替换
- **文本截断功能**: 根据令牌数量智能截断大文件内容

### 4.3 Bash 工具 (bash_tool.py)
- **BashTool**: 执行 Bash 命令，支持前台和后台执行
- **BashOutputTool**: 获取后台进程的输出
- **BashKillTool**: 终止后台进程
- **后台进程管理**: 管理后台 Shell 进程的生命周期

### 4.4 笔记工具 (note_tool.py)
- **SessionNoteTool**: 记录会话笔记，支持分类和时间戳
- **RecallNoteTool**: 回忆之前记录的笔记
- **持久化存储**: 将笔记保存到 JSON 文件中

### 4.5 技能工具 (skill_tool.py 和 skill_loader.py)
- **GetSkillTool**: 获取特定技能的详细信息
- **SkillLoader**: 加载 Claude 技能，支持 YAML 前置元数据
- **渐进式信息披露**: 分级提供技能信息，避免系统提示过载
- **路径处理**: 将相对路径转换为绝对路径

### 4.6 MCP 工具 (mcp_loader.py)
- **MCPTool**: MCP 工具的包装器
- **MCPServerConnection**: 管理单个 MCP 服务器连接
- **动态加载**: 从配置文件动态加载 MCP 工具
- **连接管理**: 管理 MCP 服务器的连接和断开

## 5. 模式定义模块 (schema/)

定义了应用中使用的数据结构。

### 主要类
- **FunctionCall**: 函数调用详情
- **ToolCall**: 工具调用结构
- **Message**: 聊天消息结构
- **LLMResponse**: LLM 响应结构

### 特点
- 使用 Pydantic 进行数据验证
- 支持 Anthropic API 的消息格式
- 包含思维链和工具调用字段

## 6. 日志模块 (logger.py)

记录代理运行过程的详细信息。

### 主要功能
- **运行日志**: 为每次代理运行创建独立的日志文件
- **请求记录**: 记录 LLM 请求（消息历史和工具列表）
- **响应记录**: 记录 LLM 响应（内容、思维、工具调用等）
- **工具结果记录**: 记录工具执行的参数和结果
- **时间戳**: 为每条日志添加时间戳

### 存储位置
- 默认存储在 ~/.mini-agent/log/ 目录

## 7. 重试模块 (retry.py)

提供优雅的异步函数重试机制。

### 主要功能
- **指数退避**: 实现指数退避策略的重试
- **配置化**: 可配置的重试次数、延迟和异常类型
- **回调支持**: 支持重试时的回调函数
- **异常处理**: 专门的重试耗尽异常

### 关键类
- **RetryConfig**: 重试配置类
- **RetryExhaustedError**: 重试耗尽异常
- **async_retry**: 异步重试装饰器

## 8. CLI 模块 (cli.py)

提供命令行交互界面。

### 主要功能
- **参数解析**: 解析命令行参数（如工作空间目录）
- **交互式会话**: 提供用户友好的交互界面
- **命令支持**: 支持特殊命令（/help, /clear, /history, /exit 等）
- **键盘快捷键**: 支持 Ctrl+U, Ctrl+L, Ctrl+J 等快捷键
- **工具初始化**: 初始化各种工具并注入工作空间信息
- **会话统计**: 显示会话统计信息

### 特性
- 使用 prompt_toolkit 实现高级终端功能
- 彩色输出增强用户体验
- 完整的帮助系统和命令支持

## 9. 初始化模块 (__init__.py)

导出包的主要接口，方便外部导入。

### 导出内容
- Agent 类
- LLMClient 类
- 消息和响应相关的数据类