# 图工作流示例实现需求文档

## 概述

基于现有的Modular Agent Framework工作流模块，创建一个简化的、硬编码的图工作流示例。该示例将演示图工作流的核心概念：节点、边、触发器的独立实体定义，以及通过函数式编程实现具体逻辑。示例不需要外部配置，不需要DDD分层架构，仅用于演示图工作流架构的基本工作原理。

## 需求列表

### 1. 节点实体定义

**用户故事**：作为工作流开发者，我想要清晰的节点实体定义，以便能够理解和使用不同类型的节点功能。

**验收标准**：
1. [ ] 定义Node实体类，包含节点ID、类型、名称、描述、属性等基本信息
2. [ ] 支持多种节点类型：LLM节点、工具调用节点、条件检查节点、数据转换节点
3. [ ] 每个节点类型有明确的输入输出规范
4. [ ] 节点实体支持序列化和反序列化
5. [ ] 节点属性使用TypeScript类型系统确保类型安全

### 2. 边实体定义

**用户故事**：作为工作流设计者，我想要灵活的边实体定义，以便能够控制工作流中的数据流向和执行顺序。

**验收标准**：
1. [ ] 定义Edge实体类，包含边ID、类型、源节点、目标节点、条件表达式等
2. [ ] 支持直接边（无条件）和条件边（基于表达式评估）
3. [ ] 边条件支持基本比较操作（等于、大于、小于等）
4. [ ] 边条件支持逻辑组合（与、或、非）
5. [ ] 边权重支持执行优先级控制

### 3. 触发器实体定义

**用户故事**：作为工作流控制者，我想要触发器实体定义，以便能够在特定条件下自动启动或控制工作流执行。

**验收标准**：
1. [ ] 定义Trigger实体类，包含触发器ID、类型、触发条件、动作等
2. [ ] 支持时间触发器（定时执行、延迟执行）
3. [ ] 支持事件触发器（基于特定事件）
4. [ ] 支持状态触发器（基于工作流状态变化）
5. [ ] 触发器支持启用/禁用状态管理

### 4. 函数式节点逻辑实现

**用户故事**：作为工作流实现者，我想要函数式编程实现的节点逻辑，以便能够清晰地理解节点执行过程。

**验收标准**：
1. [ ] LLM节点函数接收输入文本和模型参数，返回LLM处理结果
2. [ ] 工具调用节点函数接收工具名称和参数，返回工具执行结果
3. [ ] 条件检查节点函数接收条件和数据，返回布尔判断结果
4. [ ] 数据转换节点函数接收输入数据和转换规则，返回转换后数据
5. [ ] 所有节点函数都是纯函数，无副作用（除LLM调用外）
6. [ ] 节点函数支持异步执行

### 5. 函数式边条件评估

**用户故事**：作为工作流控制者，我想要函数式编程实现的边条件评估，以便能够灵活控制工作流分支。

**验收标准**：
1. [ ] 条件评估函数接收条件表达式和上下文数据，返回评估结果
2. [ ] 支持表达式解析和求值（使用简单模板语法）
3. [ ] 支持比较运算符（==、!=、>、<、>=、<=）
4. [ ] 支持逻辑运算符（&&、||、!）
5. [ ] 支持变量替换（从上下文中获取变量值）
6. [ ] 条件评估函数是纯函数，无副作用

### 6. 函数式触发器逻辑

**用户故事**：作为工作流自动化设计者，我想要函数式编程实现的触发器逻辑，以便能够灵活定义触发条件。

**验收标准**：
1. [ ] 时间触发器函数接收时间配置，返回是否触发
2. [ ] 事件触发器函数接收事件数据，返回是否匹配
3. [ ] 状态触发器函数接收当前状态和期望状态，返回是否触发
4. [ ] 触发器动作函数执行具体动作（启动工作流、暂停工作流等）
5. [ ] 触发器函数支持异步执行

### 7. 工作流执行引擎

**用户故事**：作为工作流使用者，我想要一个简单的工作流执行引擎，以便能够运行硬编码的图工作流。

**验收标准**：
1. [ ] 执行引擎能够加载和解析工作流图（节点和边）
2. [ ] 支持拓扑排序确定节点执行顺序
3. [ ] 支持串行执行模式（节点按顺序执行）
4. [ ] 支持并行执行模式（无依赖节点并行执行）
5. [ ] 维护执行上下文，存储节点执行结果
6. [ ] 根据边条件评估结果决定执行路径
7. [ ] 支持工作流执行状态跟踪（运行中、完成、失败）

### 8. 硬编码工作流示例场景

**用户故事**：作为工作流学习者，我想要一个具体的硬编码工作流示例，以便能够理解图工作流的实际应用。

**验收标准**：
1. [ ] 创建一个简单的文本分析工作流示例
2. [ ] 工作流包含4-6个节点，展示不同类型节点的使用
3. [ ] 工作流包含条件分支，展示边条件评估
4. [ ] 工作流包含触发器使用示例
5. [ ] 提供完整的执行示例代码，可直接运行
6. [ ] 示例包含详细的注释说明

### 9. 模块拆分设计

**用户故事**：作为代码维护者，我想要清晰的模块拆分，以便能够理解和维护图工作流代码。

**验收标准**：
1. [ ] 实体模块：包含Node、Edge、Trigger实体定义
2. [ ] 函数模块：包含节点函数、边条件函数、触发器函数
3. [ ] 执行引擎模块：包含工作流执行引擎和执行策略
4. [ ] 示例模块：包含硬编码工作流示例和演示代码
5. [ ] 各模块之间通过清晰的接口进行交互
6. [ ] 模块间依赖关系简单明确

### 10. 类型安全和错误处理

**用户故事**：作为代码使用者，我想要良好的类型安全和错误处理，以便能够编写可靠的图工作流代码。

**验收标准**：
1. [ ] 使用TypeScript类型系统确保类型安全
2. [ ] 节点、边、触发器配置使用接口定义
3. [ ] 函数参数和返回值有明确的类型定义
4. [ ] 执行过程中捕获和处理异常
5. [ ] 提供清晰的错误信息和堆栈跟踪
6. [ ] 支持错误恢复和重试机制（简单版本）

## 技术约束

1. **无外部配置**：所有配置硬编码在代码中，不使用配置文件
2. **无DDD分层**：不使用领域驱动设计的分层架构，代码结构简化
3. **函数式编程**：优先使用函数式编程风格，减少类和继承
4. **TypeScript**：使用TypeScript编写，确保类型安全
5. **模块化**：代码按功能模块拆分，保持清晰的模块边界
6. **演示目的**：代码以演示和教育为主要目的，可适当简化

## 非功能性需求

1. **可读性**：代码清晰易读，有详细的注释说明
2. **可运行**：提供完整的可运行示例，无需额外配置
3. **可扩展**：示例代码易于扩展，支持添加新节点类型和条件类型
4. **可测试**：函数式代码易于单元测试
5. **学习价值**：示例能够有效演示图工作流的核心概念

## 示例场景描述

### 场景：智能文本处理工作流

**流程说明**：
1. 输入一段文本
2. 使用LLM节点进行文本分类（判断文本类型：新闻、评论、问答等）
3. 根据分类结果走不同分支：
   - 如果是新闻类，提取关键信息（标题、时间、地点）
   - 如果是评论类，进行情感分析
   - 如果是问答类，提取问题和答案
4. 对处理结果进行数据格式转换
5. 返回结构化结果

**节点设计**：
- 开始节点：接收输入文本
- LLM分类节点：使用LLM进行文本分类
- 条件分支节点：根据分类结果选择分支
- 信息提取节点：提取新闻关键信息
- 情感分析节点：分析评论情感
- 问答提取节点：提取问答内容
- 数据转换节点：统一数据格式
- 结束节点：返回结果

**边条件设计**：
- 从分类节点到各分支节点的边使用条件表达式
- 例如：`classification.result == "news"`

**触发器设计**：
- 超时触发器：防止LLM调用超时
- 错误触发器：捕获处理错误并记录