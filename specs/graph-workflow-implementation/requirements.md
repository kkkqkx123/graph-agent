# 图工作流实现需求文档

## 概述

基于现有的Modular Agent Framework工作流模块，实现完整的图工作流功能。当前系统已有基础的工作流实体、图算法服务、扩展系统（hooks、plugins、triggers）和部分执行策略，但需要完善图工作流的执行引擎、节点执行器、边条件评估器等核心组件，并集成现有的扩展功能。

## 架构依赖关系修正

**正确的依赖关系**：
- **Domain层**：不依赖任何其他层，提供业务规则和实体
- **Infrastructure层**：依赖Domain层，提供具体技术实现
- **Application层**：依赖Domain层和Infrastructure层，提供业务逻辑和编排服务
- **Interface层**：依赖Application层，提供外部接口

## 需求列表

### 1. 图工作流执行引擎

**用户故事**：作为工作流用户，我想要一个完整的图工作流执行引擎，以便能够执行复杂的工作流图结构。

**验收标准**：
1. [ ] 执行引擎能够处理有向无环图(DAG)的工作流
2. [ ] 支持拓扑排序确定执行顺序
3. [ ] 支持并行和串行执行模式
4. [ ] 提供执行上下文管理
5. [ ] 支持工作流执行状态跟踪
6. [ ] 实现执行结果收集和传递
7. [ ] 集成现有的hooks系统，支持执行过程中的钩子调用
8. [ ] 集成现有的plugins系统，支持插件扩展功能

### 2. 节点执行器系统

**用户故事**：作为工作流开发者，我想要可扩展的节点执行器系统，以便能够支持不同类型的节点执行逻辑。

**验收标准**：
1. [ ] 实现LLM节点执行器，支持大语言模型调用，与提示词模块集成
2. [ ] 实现工具调用节点执行器，支持MCP工具调用
3. [ ] 实现条件检查节点执行器，支持条件判断
4. [ ] 实现数据转换节点执行器，支持数据格式转换
5. [ ] 提供节点执行器注册机制
6. [ ] 支持节点执行器的热插拔
7. [ ] 节点配置支持TOML配置驱动，允许设定所有参数

### 3. 边条件评估系统

**用户故事**：作为工作流设计者，我想要灵活的边条件评估系统，以便能够根据条件控制工作流分支。

**验收标准**：
1. [ ] 支持表达式条件评估
2. [ ] 支持比较条件（等于、大于、小于等）
3. [ ] 支持逻辑条件（与、或、非）
4. [ ] 支持变量存在性检查
5. [ ] 支持自定义函数条件（使用预定义函数）
6. [ ] 支持节点结果条件评估
7. [ ] 路由函数只允许使用预定义的，避免过度设计

### 4. 执行策略实现

**用户故事**：作为工作流管理员，我想要多种执行策略选择，以便能够根据场景选择最优的执行方式。

**验收标准**：
1. [ ] 实现串行执行策略
2. [ ] 实现并行执行策略
3. [ ] 实现条件执行策略
4. [ ] 支持策略的动态切换
5. [ ] 提供策略执行性能监控
6. [ ] 集成现有的triggers系统，支持触发条件控制

### 5. 工作流编排服务

**用户故事**：作为系统集成者，我想要完整的工作流编排服务，以便能够协调Thread和Session服务完成工作流执行。

**验收标准**：
1. [ ] 实现工作流执行入口
2. [ ] 支持并行工作流执行
3. [ ] 提供执行上下文创建
4. [ ] 实现工作流线程管理
5. [ ] 支持执行结果返回
6. [ ] 集成hooks、plugins、triggers扩展系统

### 6. 图算法服务完善

**用户故事**：作为工作流分析师，我想要完善的图算法服务，以便能够分析工作流图的复杂度和结构。

**验收标准**：
1. [ ] 实现拓扑排序算法
2. [ ] 实现循环检测算法
3. [ ] 实现连通分量分析
4. [ ] 实现路径查找算法
5. [ ] 实现图复杂度计算

### 7. 条件路由功能实现

**用户故事**：作为工作流设计者，我想要条件路由功能，以便能够根据执行结果动态选择执行路径。

**验收标准**：
1. [ ] 基于现有的conditional-routing.function.ts实现条件路由
2. [ ] 支持first、all、any三种匹配模式
3. [ ] 支持表达式评估和值比较
4. [ ] 提供默认节点ID配置
5. [ ] 避免复杂编排，使用预定义的子工作流

### 8. 配置驱动实现

**用户故事**：作为系统管理员，我想要配置驱动的图工作流系统，以便能够通过配置文件灵活调整工作流行为。

**验收标准**：
1. [ ] 节点配置支持TOML格式和环境变量注入
2. [ ] 边配置支持条件表达式和路由函数配置
3. [ ] hooks配置支持钩子点和优先级设置
4. [ ] triggers配置支持触发条件和参数设置
5. [ ] plugins配置支持插件初始化和依赖管理

### 9. 扩展系统集成

**用户故事**：作为系统扩展者，我想要完整的扩展系统集成，以便能够通过hooks、plugins、triggers扩展工作流功能。

**验收标准**：
1. [ ] 集成现有的hooks系统，支持执行过程中的钩子调用
2. [ ] 集成现有的plugins系统，支持插件扩展功能
3. [ ] 集成现有的triggers系统，支持触发条件控制
4. [ ] 提供扩展点配置和管理
5. [ ] 支持扩展的热插拔

### 10. 错误处理和重试机制

**用户故事**：作为工作流运维人员，我想要完善的错误处理和重试机制，以便能够处理执行过程中的异常情况。

**验收标准**：
1. [ ] 支持节点执行失败处理
2. [ ] 实现条件评估失败处理
3. [ ] 提供重试机制配置
4. [ ] 支持错误传播控制
5. [ ] 实现超时处理机制

### 11. 执行状态管理

**用户故事**：作为工作流监控者，我想要详细的执行状态管理，以便能够跟踪工作流执行进度。

**验收标准**：
1. [ ] 实现节点执行状态跟踪
2. [ ] 支持工作流整体状态管理
3. [ ] 提供执行历史记录
4. [ ] 实现执行结果持久化
5. [ ] 支持执行状态查询

## 技术约束

1. **架构约束**：严格遵循Domain + Application + Infrastructure + Interface的分层架构
2. **依赖约束**：基础设施层依赖领域层，应用层依赖领域层和基础设施层，接口层依赖应用层
3. **配置驱动**：使用TOML配置文件和环境变量注入
4. **多模型支持**：支持OpenAI、Gemini、Anthropic、Mock等LLM模型
5. **工具系统**：支持内置、原生、REST和MCP工具
6. **避免过度设计**：工作流设置尽量使用预定义的子工作流，路由函数等只允许使用预定义的

## 非功能性需求

1. **性能**：支持并发执行多个工作流
2. **可扩展性**：支持新的节点类型和边条件类型
3. **可靠性**：提供完善的错误处理和重试机制
4. **可维护性**：代码结构清晰，易于理解和修改
5. **可测试性**：提供完整的单元测试和集成测试