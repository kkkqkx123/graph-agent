# Workflow集成测试计划

## 概述

本文档详细描述了sdk/core中workflow操作的功能划分和相应的集成测试策略。基于对现有代码的分析，我们将集成测试划分为8个主要功能模块，每个模块都有明确的测试范围和关键场景。

## 功能模块划分

### 1. 工作流注册与预处理集成测试

**测试范围**: WorkflowRegistry + GraphBuilder + 验证系统

**关键场景**:
- 完整工作流生命周期（从模板加载到注册）
- 模板系统集成（节点模板和触发器模板展开）
- 子工作流处理和递归深度限制
- 异常路径处理（无效引用、循环依赖等）
- 批量操作和缓存管理

**测试文件**: `sdk/tests/workflow-registry/workflow-registration-integration.test.ts`

### 2. 线程构建与上下文创建集成测试

**测试范围**: ThreadBuilder + WorkflowRegistry + GraphRegistry + ThreadContext

**关键场景**:
- 完整Thread构建到执行实例创建生命周期
- 变量作用域初始化和输入处理
- Thread副本创建和Fork子线程
- 异常路径和错误处理
- 性能和并发测试

**测试文件**: `sdk/tests/thread-build-execution-integration.test.ts`

### 3. 线程执行与节点处理集成测试

**测试范围**: ThreadExecutor + NodeExecutionCoordinator + 各种节点处理器

**关键场景**:
- 完整线程执行生命周期
- 节点类型处理（LLM、CODE、USER_INTERACTION等）
- 子图边界处理（进入/退出子工作流）
- 错误处理和恢复机制
- 触发器和Hook执行

**测试文件**: 需要创建新的集成测试文件

### 4. Fork/Join和并行执行集成测试

**测试范围**: Fork/Join节点 + ThreadOperationCoordinator + Join操作

**关键场景**:
- Fork操作和子线程创建
- Join操作和主线程对话历史合并
- 并行执行和同步机制
- 路径ID全局唯一化处理

**测试文件**: `sdk/core/execution/__tests__/fork-join-main-thread.test.ts` (需要扩展为集成测试)

### 5. 子工作流和嵌套执行集成测试

**测试范围**: SUBGRAPH节点 + 子工作流处理 + 上下文传递

**关键场景**:
- 子工作流图合并和边界标记
- 输入/输出映射处理
- 嵌套执行上下文管理
- 递归深度限制和循环检测

**测试文件**: 需要创建新的集成测试文件

### 6. 触发器和事件系统集成测试

**测试范围**: 触发器系统 + 事件管理器 + 触发器处理器

**关键场景**:
- 触发器注册和状态管理
- 触发条件评估和动作执行
- 事件监听和处理
- 触发子工作流处理

**测试文件**: 需要创建新的集成测试文件

### 7. 变量和状态管理集成测试

**测试范围**: VariableCoordinator + VariableStateManager + 作用域管理

**关键场景**:
- 变量作用域（global/thread/subgraph/loop）
- 变量初始化和更新
- 状态持久化和恢复
- 变量访问和路径解析

**测试文件**: 需要创建新的集成测试文件

### 8. 检查点和恢复机制集成测试

**测试范围**: Checkpoint系统 + 状态序列化 + 恢复机制

**关键场景**:
- 检查点创建和存储
- 状态恢复和继续执行
- 检查点清理策略
- 故障恢复测试

**测试文件**: `sdk/tests/checkpoint/checkpoint-creation/checkpoint-lifecycle-integration.test.ts` (需要扩展)

## 测试策略

### 测试层次
1. **单元测试**: 针对单个组件的独立功能
2. **集成测试**: 针对多个组件协同工作的场景
3. **端到端测试**: 针对完整业务流程的测试

### 测试覆盖
- **正向路径**: 正常业务流程
- **异常路径**: 错误处理和边界情况
- **性能测试**: 并发、批量操作等
- **安全测试**: 输入验证、权限控制等

### 测试数据管理
- 使用工厂函数创建测试数据
- 清理测试后的状态
- 避免测试间的数据污染

## 实施建议

1. **优先级排序**: 从核心功能开始（工作流注册、线程构建、线程执行）
2. **渐进式实施**: 先完善现有测试，再添加缺失的测试
3. **测试工具**: 利用现有的ExecutionContext和Mock服务
4. **持续集成**: 确保所有测试都能在CI环境中稳定运行

## 预期收益

1. **提高代码质量**: 通过全面的集成测试发现潜在问题
2. **增强可维护性**: 清晰的测试结构便于理解和修改
3. **加速开发**: 快速验证功能正确性，减少手动测试
4. **降低风险**: 在发布前捕获集成问题