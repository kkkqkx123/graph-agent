# 工具执行器配置分析文档

## 一、工具类型概述

根据业务逻辑的定义，工具执行器支持四种类型的工具，每种工具都有其特定的使用场景和配置需求。

### 1. 无状态工具（STATELESS）

**业务含义**：
无状态工具是应用层提供的纯函数，不依赖任何内部状态。每次调用都是独立的，不依赖于之前的调用结果，也不会影响后续的调用。

**使用场景**：
- 简单的数据计算和转换
- 数据验证和格式化
- 纯粹的业务逻辑处理
- 不需要保持会话或上下文的操作

**技术特点**：
- 直接注册函数到执行器
- 通过函数注册表管理所有函数
- 支持版本控制和调用统计
- 每次调用都是全新的执行

**配置需求分析**：

无状态工具的配置主要围绕函数注册表的管理，需要以下配置项：

**函数注册表配置**：
- 版本控制开关：决定是否启用函数版本管理，当同一函数名有多个版本时，版本控制可以确保调用正确的版本
- 调用统计开关：决定是否记录每个函数的调用次数、最后调用时间等统计信息，用于监控和性能分析
- 最大注册函数数：限制可以注册的函数数量，防止内存溢出和资源浪费

**配置使用方式**：
执行器在构造时接收配置对象，该配置对象包含函数注册表的配置。执行器内部创建函数注册表实例时使用这些配置。配置是可选的，如果不提供则使用默认值。

**当前配置状态**：
配置接口定义完整，包含所有必要的配置项。执行器在构造函数中接收配置并传递给函数注册表。配置项都有合理的默认值，确保在不提供配置时也能正常工作。

---

### 2. 有状态工具（STATEFUL）

**业务含义**：
有状态工具是应用层提供的类或对象实例，需要在多次调用之间保持状态。每个线程（会话）维护独立的工具实例，确保不同线程之间的状态互不干扰。

**使用场景**：
- 需要维护会话状态的工具（如数据库连接池）
- 需要保持上下文信息的工具（如文件编辑器）
- 需要缓存中间结果的工具（如计算器）
- 任何需要在多次调用间共享状态的业务逻辑

**技术特点**：
- 通过工厂函数创建工具实例
- 每个线程维护独立的实例
- 支持实例缓存和生命周期管理
- 实例可以有自己的清理方法

**配置需求分析**：

有状态工具的配置主要围绕实例的生命周期管理和资源控制，需要以下配置项：

**实例缓存配置**：
- 实例缓存开关：决定是否启用实例缓存。如果关闭，每次调用都会创建新实例；如果开启，会复用已创建的实例
- 最大缓存实例数：限制缓存的实例总数，防止内存占用过大。当达到上限时，需要清理策略
- 实例过期时间：设置实例的有效期，超过该时间未使用的实例会被标记为过期，可以自动清理

**自动清理配置**：
- 自动清理开关：决定是否启用定时清理过期实例的功能
- 清理间隔：设置定时清理任务的执行频率，平衡资源占用和清理及时性

**配置使用方式**：
执行器在构造时接收配置对象，该配置对象包含实例缓存和清理相关的配置。执行器内部维护一个嵌套的映射结构，按线程ID和工具名称组织实例。配置项都有合理的默认值，确保在不提供配置时也能正常工作。

**当前配置状态**：
配置接口定义完整，包含所有必要的配置项。执行器在构造函数中接收配置并初始化内部状态。配置项都有合理的默认值，实例缓存默认开启，自动清理默认开启。

---

### 3. REST工具（REST）

**业务含义**：
REST工具是通过HTTP协议调用外部RESTful API的工具，遵循REST架构风格。每次调用都是独立的HTTP请求，不依赖之前的请求状态。

**使用场景**：
- 调用第三方服务的API
- 与微服务架构中的其他服务通信
- 访问外部数据源
- 任何基于HTTP协议的RESTful接口调用

**技术特点**：
- 支持所有HTTP方法（GET、POST、PUT、DELETE等）
- 支持请求和响应拦截器
- 支持缓存机制（主要针对GET请求）
- 支持熔断器模式防止级联故障
- 支持超时控制和错误处理

**配置需求分析**：

REST工具的配置主要围绕HTTP客户端的行为控制和增强功能，需要以下配置项：

**基础HTTP配置**：
- 基础URL：所有请求的统一前缀，避免在每个请求中重复指定
- 默认请求头：所有请求都会携带的HTTP头，如认证信息、内容类型等
- 默认超时时间：请求的超时限制，防止长时间等待

**拦截器配置**：
- 请求拦截器：在发送请求前对请求进行预处理，如添加签名、修改参数等
- 响应拦截器：在收到响应后对响应进行后处理，如数据转换、错误处理等
- 错误拦截器：在发生错误时进行统一处理，如日志记录、重试逻辑等

**缓存配置**：
- 缓存开关：决定是否启用HTTP响应缓存
- 默认缓存时间：GET请求响应的默认缓存有效期
- 缓存大小限制：缓存的最大条目数，防止内存占用过大

**熔断器配置**：
- 熔断器开关：决定是否启用熔断器模式
- 失败阈值：在多少次失败后打开熔断器
- 重置超时：熔断器打开后，多久尝试进入半开状态
- 半开请求数：在半开状态下允许的测试请求数量

**配置使用方式**：
执行器在构造时接收配置对象，该配置对象包含HTTP客户端的所有配置。执行器内部创建HTTP客户端、拦截器管理器和缓存实例，并根据配置进行初始化。配置项都是可选的，如果不提供则使用默认值。

**当前配置状态**：
配置接口定义完整，包含所有必要的配置项。执行器在构造函数中接收配置并初始化所有依赖组件。配置项都有合理的默认值，缓存默认开启，熔断器默认关闭。

---

### 4. MCP工具（MCP）

**业务含义**：
MCP工具是使用模型上下文协议（Model Context Protocol）的工具，通过stdio或SSE传输协议与MCP服务器通信。MCP协议定义了标准化的工具调用接口。

**使用场景**：
- 与MCP服务器交互，调用模型相关的工具
- 使用标准化的协议访问AI模型能力
- 需要会话管理和连接池的场景
- 任何基于MCP协议的工具调用

**技术特点**：
- 支持stdio和SSE两种传输协议
- 使用会话池管理多个服务器连接
- 支持健康检查和自动重连
- 支持连接数限制和超时控制
- 每个服务器可以有独立的配置

**配置需求分析**：

MCP工具的配置主要围绕会话池的管理和服务器连接的控制，需要以下配置项：

**会话池配置**：
- 最大连接数：会话池中允许的最大连接数，防止资源耗尽
- 最小连接数：会话池中保持的最小连接数，确保有可用连接
- 连接超时：建立连接的超时时间，防止长时间等待
- 空闲超时：连接空闲多久后可以被关闭，释放资源
- 健康检查间隔：定期检查连接健康状态的频率

**服务器配置**：
- 服务器名称：标识不同的MCP服务器
- 启动命令：启动MCP服务器的命令（如npx、python等）
- 命令参数：启动服务器时需要的参数
- 环境变量：服务器运行时需要的环境变量
- 工作目录：服务器运行的工作目录

**配置使用方式**：
执行器在构造时接收会话池配置对象，该配置对象包含会话池的所有配置。执行器内部创建会话池实例，并根据配置进行初始化。服务器配置在执行工具时动态获取和创建，支持从工具配置中读取或使用默认配置。配置项都是可选的，如果不提供则使用默认值。

**当前配置状态**：
配置接口定义完整，包含所有必要的配置项。执行器在构造函数中接收会话池配置并初始化会话池。服务器配置在执行时动态创建，支持从工具配置中读取serverUrl或使用默认配置。

---

## 二、配置设计原则

### 1. 配置的必要性

每种工具的配置都是必要的，因为：

- **无状态工具**：需要配置函数注册表的行为，如版本控制和统计功能
- **有状态工具**：需要配置实例的生命周期管理，防止内存泄漏和资源浪费
- **REST工具**：需要配置HTTP客户端的各种行为，如超时、缓存、熔断等
- **MCP工具**：需要配置会话池和服务器连接，确保稳定性和性能

### 2. 配置的默认值

所有配置项都应该有合理的默认值，确保在不提供配置时也能正常工作：

- 无状态工具：版本控制关闭，调用统计开启，最大函数数设为合理值
- 有状态工具：实例缓存开启，自动清理开启，过期时间设为合理值
- REST工具：缓存开启，熔断器关闭，超时时间设为合理值
- MCP工具：连接数设为合理值，超时时间设为合理值

### 3. 配置的可选性

所有配置都应该是可选的，用户可以根据需要覆盖默认值：

- 使用TypeScript的可选属性语法
- 在构造函数中提供默认值
- 使用部分类型允许只覆盖部分配置

### 4. 配置的存储

执行器应该存储配置对象，以便在运行时访问配置值：

- 无状态工具：需要存储配置以传递给函数注册表
- 有状态工具：需要存储配置以控制实例管理行为
- REST工具：需要存储配置以供拦截器和缓存使用
- MCP工具：需要存储配置以控制会话池行为

---

## 三、配置使用建议

### 1. 无状态工具配置建议

- 如果不需要版本控制，可以关闭以减少开销
- 如果需要监控函数使用情况，应该开启调用统计
- 如果函数数量很多，应该设置合理的最大函数数限制

### 2. 有状态工具配置建议

- 实例缓存应该默认开启，以提高性能
- 过期时间应该根据业务需求设置，避免实例长期占用内存
- 自动清理应该开启，以防止内存泄漏
- 清理间隔应该平衡资源占用和清理及时性

### 3. REST工具配置建议

- 基础URL应该统一设置，避免在每个请求中重复
- 认证信息应该通过默认请求头设置
- 缓存应该针对GET请求启用，以提高性能
- 熔断器应该在关键服务上启用，防止级联故障
- 拦截器应该用于统一的请求和响应处理

### 4. MCP工具配置建议

- 连接数应该根据服务器负载能力设置
- 超时时间应该根据网络状况和服务器响应时间设置
- 健康检查应该启用，以及时发现和恢复故障连接
- 服务器配置应该从工具配置中读取，支持灵活的服务器管理

---

## 四、总结

所有四种工具类型的配置都是必要的，它们控制着工具执行器的核心行为：

1. **无状态工具配置**：控制函数注册表的行为，包括版本控制、调用统计和函数数量限制
2. **有状态工具配置**：控制实例的生命周期管理，包括缓存、过期和自动清理
3. **REST工具配置**：控制HTTP客户端的行为，包括基础配置、拦截器、缓存和熔断器
4. **MCP工具配置**：控制会话池和服务器连接，包括连接数、超时和健康检查

所有配置都应该有合理的默认值，都是可选的，并且应该在执行器中存储以便运行时使用。配置的设计应该遵循简单、灵活、可扩展的原则，满足不同场景的需求。