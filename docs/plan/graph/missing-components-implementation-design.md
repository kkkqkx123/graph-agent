# 图工作流缺失组件实现设计

## 概述

基于对 `src/infrastructure/workflow` 目录的分析，识别出需要实现的缺失组件。本文档提供这些组件的初步设计思路。

## 缺失组件列表

### 1. 开始/结束节点实现

**当前状态**：领域层定义了 `START` 和 `END` 节点类型，但基础设施层缺少具体实现。

**设计思路**：
- **StartNode**：
  - 继承 [`Node`](src/domain/workflow/entities/node.ts:91) 基类
  - 实现简单的开始逻辑，主要作为工作流入口点
  - 可以包含初始化上下文变量的功能

- **EndNode**：
  - 继承 [`Node`](src/domain/workflow/entities/node.ts:91) 基类
  - 实现工作流结束逻辑
  - 负责收集执行结果和清理资源

**实现位置**：`src/infrastructure/workflow/nodes/`

### 2. 并行处理节点（FORK/JOIN）

**当前状态**：领域层定义了 `FORK` 和 `JOIN` 节点类型，但基础设施层缺少实现。

**设计思路**：
- **ForkNode**：
  - 将执行流拆分为多个并行分支
  - 支持动态分支数量配置
  - 实现分支上下文隔离

- **JoinNode**：
  - 等待所有并行分支完成
  - 支持多种合并策略（全部完成、任意完成、多数完成）
  - 实现分支结果合并

**关键技术**：
- 使用 Promise.all 或类似机制管理并行执行
- 实现分支间的数据同步和冲突解决

**实现位置**：`src/infrastructure/workflow/nodes/parallel/`

### 3. 子工作流节点（SUBGRAPH）

**当前状态**：领域层定义了 `SUBGRAPH` 节点类型，但基础设施层缺少实现。

**设计思路**：
- **SubgraphNode**：
  - 引用另一个工作流定义
  - 支持嵌套执行上下文
  - 实现输入输出参数映射

**关键技术**：
- 工作流实例化和管理
- 上下文隔离和参数传递
- 错误处理和结果返回

**实现位置**：`src/infrastructure/workflow/nodes/subgraph/`

### 4. 等待节点（WAIT）

**当前状态**：领域层定义了 `WAIT` 节点类型，但基础设施层缺少实现。

**设计思路**：
- **WaitNode**：
  - 支持时间等待（秒、分钟、小时）
  - 支持条件等待（直到某个条件满足）
  - 支持外部事件等待

**关键技术**：
- 定时器管理
- 条件轮询机制
- 事件监听

**实现位置**：`src/infrastructure/workflow/nodes/wait/`

### 5. 用户交互节点（USER_INTERACTION）

**当前状态**：领域层定义了 `USER_INTERACTION` 节点类型（原HUMAN_RELAY），但基础设施层缺少实现。

**设计思路**：
- **UserInteractionNode**：
  - 暂停工作流执行，等待用户输入
  - 支持多种交互方式（表单、审批、通知、对话）
  - 实现超时和重试机制
  - 支持多轮对话和上下文保持

**关键技术**：
- 用户任务队列管理
- 通知机制集成
- 超时处理
- 对话状态管理

**实现位置**：`src/infrastructure/workflow/nodes/user-interaction/`

## 边执行器改进

### 当前问题
- [`EdgeExecutor`](src/infrastructure/workflow/edges/edge-executor.ts:24) 中的 `canExecute` 方法返回硬编码 `true`
- 缺少实际的边条件评估逻辑

### 改进方案
1. **完善条件评估**：
   - 实现基于表达式的条件评估
   - 支持变量引用和函数调用

2. **优先级处理**：
   - 实现边优先级排序算法
   - 支持动态优先级调整

3. **错误处理**：
   - 添加边执行失败的处理机制
   - 支持边执行重试

## 函数注册表优化

### 当前问题
- [`FunctionRegistry`](src/infrastructure/workflow/functions/registry/function-registry.ts:88) 中的便捷方法缺少类型检查

### 改进方案
1. **类型安全**：
   - 为每种函数类型定义专用接口
   - 实现类型安全的函数注册和获取

2. **函数发现**：
   - 实现自动函数发现机制
   - 支持插件式函数扩展

## 图算法完善

### 当前问题
- [`GraphValidationServiceImpl`](src/infrastructure/workflow/services/graph-validation-service.ts:232) 中的循环检测暂时返回 `true`

### 改进方案
1. **循环检测算法**：
   - 实现基于DFS的循环检测
   - 支持复杂循环模式识别

2. **性能优化**：
   - 实现增量图算法
   - 支持缓存和预计算

## 实现优先级

### 高优先级（核心功能）
1. **开始/结束节点** - 工作流基本结构完整性
2. **边执行器改进** - 路由决策准确性

### 中优先级（扩展功能）
1. **并行处理节点** - 支持复杂工作流模式
2. **子工作流节点** - 支持模块化设计

### 低优先级（高级功能）
1. **等待节点** - 支持异步操作
2. **用户交互节点** - 支持人机协作

## 技术考虑

### 依赖管理
- 确保新组件与现有架构兼容
- 遵循依赖注入模式
- 保持与领域层契约的一致性

### 性能考虑
- 避免不必要的资源消耗
- 实现合理的缓存策略
- 支持大规模工作流执行

### 可测试性
- 为每个组件提供单元测试
- 实现集成测试场景
- 支持模拟和桩测试

## 总结

通过实现这些缺失组件，图工作流基础设施将能够支持更复杂的工作流模式，包括并行处理、嵌套工作流、人工干预等高级特性。实现时应遵循现有的架构模式，确保与领域层契约的一致性。