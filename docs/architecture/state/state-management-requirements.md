# 状态管理功能需求文档

## 文档信息

- **文档版本**: 1.0.0
- **创建日期**: 2025-01-09
- **最后更新**: 2025-01-09
- **状态**: 草稿

## 1. 概述

### 1.1 背景

当前项目的状态管理功能分散在多个模块中，包括：
- **Thread模块**: 管理线程执行状态
- **Session模块**: 管理会话状态
- **Checkpoint模块**: 管理检查点状态（已与Thread集成）
- **History模块**: 历史记录（尚未正式集成）
- **Snapshot模块**: 快照机制（尚未实现）

### 1.2 目标

建立统一、完整的状态管理体系，实现：
1. 多层级状态管理（Session、Thread、Node）
2. 完整的历史记录追踪
3. 灵活的检查点机制
4. 全局快照功能
5. 状态持久化和恢复

### 1.3 范围

本文档定义状态管理的功能需求，包括：
- 状态管理的核心功能
- 不同层级的状态管理需求
- Checkpoint、History、Snapshot的功能需求
- 状态持久化和恢复需求

## 2. 状态管理核心功能

### 2.1 状态层级

```
Session (会话级)
  ├── Thread (线程级)
  │   ├── ThreadExecution (执行状态)
  │   │   ├── NodeExecution (节点执行状态)
  │   │   └── ExecutionContext (执行上下文)
  │   ├── Checkpoint (检查点)
  │   └── History (历史记录)
  └── Snapshot (快照)
```

### 2.2 状态类型

#### 2.2.1 会话状态 (Session State)

**职责**:
- 管理会话生命周期
- 跟踪会话活动
- 管理会话配置

**状态信息**:
- 会话ID
- 用户ID
- 会话状态 (active/paused/closed)
- 活动信息 (最后活动时间、消息数量、线程数量)
- 配置信息 (超时时间、最大消息数、最大持续时间)
- 元数据

**状态转换**:
```
active → paused → active
active → closed
paused → closed
```

#### 2.2.2 线程状态 (Thread State)

**职责**:
- 管理线程生命周期
- 协调串行执行流程
- 跟踪执行进度

**状态信息**:
- 线程ID
- 会话ID
- 工作流ID
- 线程状态 (pending/running/paused/completed/failed/cancelled)
- 执行进度 (0-100)
- 当前步骤
- 开始时间、完成时间
- 错误信息
- 重试次数
- 优先级

**状态转换**:
```
pending → running
running → paused → running
running → completed
running → failed
running → cancelled
paused → cancelled
```

#### 2.2.3 执行状态 (Execution State)

**职责**:
- 管理线程执行上下文
- 跟踪节点执行状态
- 记录操作历史

**状态信息**:
- 执行上下文 (变量、节点上下文)
- 节点执行状态映射
- 操作历史记录
- Fork信息
- Copy信息
- 工作流状态

#### 2.2.4 节点执行状态 (Node Execution State)

**职责**:
- 管理单个节点的执行状态
- 跟踪节点执行结果

**状态信息**:
- 节点ID
- 节点状态 (pending/running/completed/failed/skipped)
- 开始时间、结束时间
- 执行结果
- 错误信息
- 重试次数

## 3. Checkpoint功能需求

### 3.1 检查点类型

#### 3.1.1 自动检查点 (Automatic Checkpoint)

**触发条件**:
- 节点执行完成
- 工作流达到里程碑
- 定时触发（基于时间间隔）
- 基于进度触发（如每完成10%）

**特点**:
- 系统自动创建
- 无需用户干预
- 可配置触发策略

#### 3.1.2 手动检查点 (Manual Checkpoint)

**触发条件**:
- 用户显式创建
- 通过API调用
- 通过配置指定关键点

**特点**:
- 用户控制创建时机
- 可添加自定义标签和描述
- 适用于关键业务节点

#### 3.1.3 错误检查点 (Error Checkpoint)

**触发条件**:
- 节点执行失败
- 工作流异常终止
- 超时错误

**特点**:
- 自动创建
- 包含错误信息和堆栈
- 支持错误恢复

#### 3.1.4 里程碑检查点 (Milestone Checkpoint)

**触发条件**:
- 工作流关键节点
- 重要业务阶段完成
- 用户定义的里程碑

**特点**:
- 标记重要阶段
- 可用于进度报告
- 支持里程碑跳转

### 3.2 检查点功能

#### 3.2.1 创建检查点

**功能描述**: 在指定时刻创建检查点，保存当前状态

**输入参数**:
- threadId: 线程ID
- type: 检查点类型
- stateData: 状态数据
- title: 标题（可选）
- description: 描述（可选）
- tags: 标签（可选）
- metadata: 元数据（可选）
- expirationHours: 过期小时数（可选）

**输出**:
- checkpointId: 检查点ID
- createdAt: 创建时间
- sizeBytes: 数据大小

**业务规则**:
- 检查点必须包含有效的状态数据
- 错误检查点必须包含描述
- 里程碑检查点必须包含标题
- 数据大小不能超过限制（如10MB）

#### 3.2.2 恢复检查点

**功能描述**: 从检查点恢复线程执行状态

**输入参数**:
- checkpointId: 检查点ID
- restoreStrategy: 恢复策略（full/partial）

**输出**:
- restoredThread: 恢复后的线程
- restoreTime: 恢复时间

**业务规则**:
- 只能恢复有效的检查点
- 检查点不能已过期
- 检查点不能已损坏
- 恢复后增加恢复计数

#### 3.2.3 查询检查点

**功能描述**: 查询符合条件的检查点

**查询条件**:
- threadId: 线程ID
- type: 检查点类型
- status: 检查点状态
- tags: 标签
- timeRange: 时间范围
- limit: 返回数量限制

**输出**:
- checkpoints: 检查点列表
- totalCount: 总数量

#### 3.2.4 管理检查点

**功能描述**: 管理检查点的生命周期

**操作**:
- 标记过期
- 标记损坏
- 标记归档
- 删除检查点
- 延长过期时间

**业务规则**:
- 已删除的检查点不能操作
- 归档的检查点不能恢复
- 过期的检查点自动标记

### 3.3 检查点状态

**状态类型**:
- active: 活跃状态，可用于恢复
- expired: 已过期，不能恢复
- corrupted: 已损坏，不能恢复
- archived: 已归档，不能恢复

**状态转换**:
```
active → expired
active → corrupted
active → archived
```

## 4. History功能需求

### 4.1 历史记录类型

#### 4.1.1 执行历史 (Execution History)

**记录内容**:
- 节点执行事件
- 工作流执行事件
- 状态变更事件

**触发时机**:
- 节点开始执行
- 节点执行完成
- 节点执行失败
- 工作流开始
- 工作流完成
- 工作流失败

#### 4.1.2 操作历史 (Operation History)

**记录内容**:
- 用户操作事件
- 系统操作事件
- 管理操作事件

**触发时机**:
- 创建线程
- 暂停线程
- 恢复线程
- 取消线程
- Fork线程
- Copy线程

#### 4.1.3 状态变更历史 (State Change History)

**记录内容**:
- 状态变更事件
- 状态变更原因
- 状态变更时间

**触发时机**:
- 线程状态变更
- 会话状态变更
- 节点状态变更

#### 4.1.4 错误历史 (Error History)

**记录内容**:
- 错误事件
- 错误信息
- 错误堆栈
- 错误上下文

**触发时机**:
- 节点执行失败
- 工作流执行失败
- 系统异常

### 4.2 历史记录功能

#### 4.2.1 记录历史

**功能描述**: 自动记录系统事件

**输入参数**:
- type: 历史类型
- details: 详细信息
- sessionId: 会话ID（可选）
- threadId: 线程ID（可选）
- workflowId: 工作流ID（可选）
- nodeId: 节点ID（可选）
- title: 标题（可选）
- description: 描述（可选）
- metadata: 元数据（可选）

**输出**:
- historyId: 历史记录ID
- createdAt: 创建时间

**业务规则**:
- 历史记录必须包含类型和详细信息
- 至少关联一个实体（session/thread/workflow/node）
- 历史记录不可修改

#### 4.2.2 查询历史

**功能描述**: 查询符合条件的历史记录

**查询条件**:
- sessionId: 会话ID
- threadId: 线程ID
- workflowId: 工作流ID
- nodeId: 节点ID
- type: 历史类型
- timeRange: 时间范围
- limit: 返回数量限制
- offset: 偏移量

**输出**:
- histories: 历史记录列表
- totalCount: 总数量

#### 4.2.3 历史分析

**功能描述**: 分析历史记录，提供统计信息

**分析维度**:
- 执行时间统计
- 错误率统计
- 节点执行频率
- 状态变更频率

**输出**:
- statistics: 统计信息
- trends: 趋势数据

### 4.3 历史记录保留策略

**保留策略**:
- 执行历史: 保留30天
- 操作历史: 保留90天
- 状态变更历史: 保留90天
- 错误历史: 保留180天

**清理策略**:
- 定时清理过期记录
- 支持手动清理
- 清理前备份重要记录

## 5. Snapshot功能需求

### 5.1 快照类型

#### 5.1.1 会话快照 (Session Snapshot)

**包含内容**:
- 会话状态
- 会话配置
- 会话元数据
- 所有线程的引用

**触发条件**:
- 会话创建
- 会话关闭
- 定时触发
- 手动触发

#### 5.1.2 线程快照 (Thread Snapshot)

**包含内容**:
- 线程状态
- 线程执行状态
- 所有检查点
- 执行上下文

**触发条件**:
- 线程创建
- 线程完成
- 定时触发
- 手动触发

#### 5.1.3 全局快照 (Global Snapshot)

**包含内容**:
- 所有会话状态
- 所有线程状态
- 所有检查点
- 所有历史记录

**触发条件**:
- 系统启动
- 系统关闭
- 定时触发（如每天）
- 手动触发

### 5.2 快照功能

#### 5.2.1 创建快照

**功能描述**: 创建指定范围的快照

**输入参数**:
- scope: 快照范围 (session/thread/global)
- targetId: 目标ID（session或thread快照需要）
- title: 标题
- description: 描述
- metadata: 元数据

**输出**:
- snapshotId: 快照ID
- createdAt: 创建时间
- sizeBytes: 数据大小

**业务规则**:
- 快照必须包含完整的状态信息
- 快照数据不能超过限制（如100MB）
- 全局快照需要管理员权限

#### 5.2.2 恢复快照

**功能描述**: 从快照恢复系统状态

**输入参数**:
- snapshotId: 快照ID
- restoreStrategy: 恢复策略（full/partial）

**输出**:
- restoredEntities: 恢复的实体列表
- restoreTime: 恢复时间

**业务规则**:
- 只能恢复有效的快照
- 恢复前需要备份当前状态
- 恢复操作需要管理员权限
- 恢复后需要验证状态一致性

#### 5.2.3 查询快照

**功能描述**: 查询符合条件的快照

**查询条件**:
- scope: 快照范围
- targetId: 目标ID
- timeRange: 时间范围
- limit: 返回数量限制

**输出**:
- snapshots: 快照列表
- totalCount: 总数量

#### 5.2.4 管理快照

**功能描述**: 管理快照的生命周期

**操作**:
- 删除快照
- 导出快照
- 导入快照
- 验证快照

**业务规则**:
- 删除快照需要管理员权限
- 导出快照需要验证数据完整性
- 导入快照需要验证格式和版本

### 5.3 快照存储

**存储策略**:
- 压缩存储
- 增量存储（仅存储变更）
- 分布式存储（支持大规模快照）

**存储位置**:
- 本地文件系统
- 云存储（S3、OSS等）
- 数据库（大对象存储）

## 6. 状态持久化需求

### 6.1 持久化策略

#### 6.1.1 实时持久化

**适用场景**:
- 关键状态变更
- 检查点创建
- 历史记录创建

**特点**:
- 立即持久化
- 保证数据不丢失
- 性能开销较大

#### 6.1.2 批量持久化

**适用场景**:
- 节点执行状态更新
- 执行上下文更新
- 元数据更新

**特点**:
- 定时批量持久化
- 性能较好
- 可能丢失少量数据

#### 6.1.3 延迟持久化

**适用场景**:
- 临时状态
- 中间计算结果
- 调试信息

**特点**:
- 延迟持久化
- 性能最好
- 可能丢失数据

### 6.2 持久化接口

**接口定义**:
```typescript
interface StatePersistenceService {
  // 保存状态
  saveState(state: StateData): Promise<void>;
  
  // 加载状态
  loadState(stateId: ID): Promise<StateData>;
  
  // 删除状态
  deleteState(stateId: ID): Promise<void>;
  
  // 查询状态
  queryStates(query: StateQuery): Promise<StateData[]>;
}
```

### 6.3 持久化存储

**存储选项**:
- 关系型数据库（PostgreSQL、MySQL）
- 文档数据库（MongoDB）
- 键值存储（Redis）
- 对象存储（S3、OSS）

**选择标准**:
- 数据一致性要求
- 性能要求
- 成本考虑
- 运维复杂度

## 7. 状态恢复需求

### 7.1 恢复策略

#### 7.1.1 完全恢复 (Full Restore)

**描述**: 恢复到指定状态的完整副本

**适用场景**:
- 从检查点恢复
- 从快照恢复
- 灾难恢复

**特点**:
- 恢复所有状态
- 恢复时间较长
- 需要停止服务

#### 7.1.2 部分恢复 (Partial Restore)

**描述**: 只恢复部分状态

**适用场景**:
- 恢复单个线程
- 恢复单个节点
- 调试和测试

**特点**:
- 恢复部分状态
- 恢复时间较短
- 不需要停止服务

#### 7.1.3 增量恢复 (Incremental Restore)

**描述**: 基于当前状态，应用变更

**适用场景**:
- 从最近的检查点恢复
- 应用历史记录
- 状态同步

**特点**:
- 只应用变更
- 恢复时间最短
- 需要状态版本控制

### 7.2 恢复流程

**恢复步骤**:
1. 验证恢复点有效性
2. 备份当前状态
3. 停止相关服务（完全恢复）
4. 加载恢复数据
5. 验证数据完整性
6. 应用恢复数据
7. 验证状态一致性
8. 重启服务（完全恢复）
9. 记录恢复操作

### 7.3 恢复验证

**验证内容**:
- 数据完整性
- 状态一致性
- 业务规则验证
- 性能验证

**验证方法**:
- 自动化验证脚本
- 手动验证
- 业务测试

## 8. 状态监控需求

### 8.1 监控指标

**状态指标**:
- 活跃会话数
- 活跃线程数
- 检查点数量
- 历史记录数量
- 快照数量

**性能指标**:
- 状态持久化延迟
- 状态恢复时间
- 检查点创建时间
- 快照创建时间

**资源指标**:
- 状态存储空间
- 检查点存储空间
- 历史记录存储空间
- 快照存储空间

### 8.2 告警规则

**告警条件**:
- 状态持久化失败
- 状态恢复失败
- 检查点创建失败
- 存储空间不足
- 恢复时间过长

**告警级别**:
- 严重: 立即处理
- 警告: 尽快处理
- 提示: 关注即可

## 9. 非功能性需求

### 9.1 性能需求

- 检查点创建时间 < 1秒
- 检查点恢复时间 < 5秒
- 历史记录创建时间 < 100ms
- 快照创建时间 < 30秒
- 快照恢复时间 < 2分钟

### 9.2 可靠性需求

- 状态持久化成功率 > 99.9%
- 状态恢复成功率 > 99%
- 数据一致性保证
- 故障自动恢复

### 9.3 可扩展性需求

- 支持水平扩展
- 支持分布式存储
- 支持大规模并发
- 支持海量历史记录

### 9.4 安全性需求

- 状态数据加密
- 访问权限控制
- 审计日志
- 数据备份

## 10. 约束条件

### 10.1 技术约束

- 使用TypeScript开发
- 遵循DDD架构
- 使用现有基础设施

### 10.2 业务约束

- 遵循现有业务规则
- 保持向后兼容
- 不影响现有功能

### 10.3 运维约束

- 支持热部署
- 支持灰度发布
- 支持回滚

## 11. 依赖关系

### 11.1 内部依赖

- 依赖Thread模块
- 依赖Session模块
- 依赖Workflow模块

### 11.2 外部依赖

- 数据库（PostgreSQL）
- 缓存（Redis）
- 对象存储（可选）

## 12. 交付物

### 12.1 代码交付

- 状态管理模块代码
- 单元测试
- 集成测试

### 12.2 文档交付

- API文档
- 设计文档
- 运维文档
- 用户手册

## 13. 验收标准

### 13.1 功能验收

- 所有功能需求已实现
- 所有业务规则已验证
- 所有接口已测试

### 13.2 性能验收

- 所有性能指标已达标
- 压力测试通过
- 性能优化完成

### 13.3 质量验收

- 代码覆盖率 > 80%
- 无严重缺陷
- 文档完整

## 14. 附录

### 14.1 术语表

- **Checkpoint**: 检查点，保存特定时刻的执行状态
- **History**: 历史记录，记录系统事件
- **Snapshot**: 快照，保存完整的系统状态
- **State**: 状态，系统在特定时刻的数据
- **Persistence**: 持久化，将状态保存到持久存储
- **Restore**: 恢复，从持久存储加载状态

### 14.2 参考资料

- [session-thread-workflow-design.md](../session-thread-workflow-design.md)
- [AGENTS.md](../../AGENTS.md)

### 14.3 变更历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 1.0.0 | 2025-01-09 | Architect | 初始版本 |