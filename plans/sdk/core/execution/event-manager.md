# EventManager 设计文档

## 需求分析

### 核心需求
管理工作流执行过程中的事件，提供事件监听和分发机制。

### 功能需求
1. 注册事件监听器
2. 注销事件监听器
3. 触发事件
4. 支持一次性监听器
5. 支持异步事件处理
6. 支持事件过滤

### 非功能需求
1. 性能：高效的事件分发
2. 可靠性：确保事件被正确处理
3. 灵活性：支持多种监听模式

## 核心职责

1. 事件监听器管理
2. 事件分发
3. 事件过滤
4. 监听器生命周期管理

## 主要属性

- listeners: 事件监听器映射，按事件类型组织
- wildcardListeners: 通配符监听器数组

## 核心方法

### on 方法

注册事件监听器。

执行步骤：

步骤 1：验证参数
- 检查 eventType 是否有效
- 检查 listener 是否为函数
- 如果参数无效，抛出 Error

步骤 2：创建监听器包装器
- 创建监听器对象
- 包含 listener 函数
- 包含注册时间戳
- 包含唯一 ID

步骤 3：添加到监听器列表
- 根据 eventType 获取对应的监听器数组
- 如果不存在，创建新数组
- 将监听器包装器添加到数组

步骤 4：返回注销函数
- 返回一个函数，调用该函数可以注销监听器

### off 方法

注销事件监听器。

执行步骤：

步骤 1：验证参数
- 检查 eventType 是否有效
- 检查 listener 是否为函数
- 如果参数无效，抛出 Error

步骤 2：获取监听器数组
- 根据 eventType 获取监听器数组
- 如果不存在，直接返回

步骤 3：查找并移除监听器
- 遍历监听器数组
- 找到匹配的 listener
- 从数组中移除

步骤 4：返回是否成功
- 返回是否找到并移除了监听器

### emit 方法

触发事件。

执行步骤：

步骤 1：验证事件
- 检查 event 是否有效
- 检查 event.type 是否有效
- 如果事件无效，抛出 Error

步骤 2：获取监听器数组
- 根据 event.type 获取监听器数组
- 如果不存在，获取通配符监听器数组

步骤 3：执行监听器
- 遍历所有监听器
- 调用每个监听器函数
- 传入 event 作为参数
- 等待异步监听器完成

步骤 4：处理监听器错误
- 捕获监听器执行过程中的错误
- 记录错误日志
- 不影响其他监听器的执行

步骤 5：返回执行结果
- 返回 Promise，等待所有监听器完成

### once 方法

注册一次性事件监听器。

执行步骤：

步骤 1：验证参数
- 检查 eventType 是否有效
- 检查 listener 是否为函数
- 如果参数无效，抛出 Error

步骤 2：创建包装监听器
- 创建一个新的监听器函数
- 在函数内部调用原始 listener
- 调用后自动注销自己

步骤 3：注册包装监听器
- 调用 on 方法
- 传入 eventType 和包装监听器

步骤 4：返回注销函数
- 返回注销函数

### clear 方法

清空事件监听器。

执行步骤：

步骤 1：检查参数
- 如果传入了 eventType，只清空该类型的监听器
- 如果没有传入 eventType，清空所有监听器

步骤 2：清空监听器
- 删除对应的监听器数组
- 或清空所有监听器映射

步骤 3：返回是否成功
- 返回是否成功清空

### waitFor 方法

等待特定事件触发。

执行步骤：

步骤 1：创建 Promise
- 创建一个新的 Promise
- 保存 resolve 和 reject 函数

步骤 2：注册一次性监听器
- 调用 once 方法
- 传入 eventType
- 在监听器中调用 resolve

步骤 3：设置超时（可选）
- 如果传入了 timeout，设置超时
- 超时后调用 reject

步骤 4：返回 Promise
- 返回创建的 Promise

## 事件类型

### 线程事件
- THREAD_STARTED: 线程开始
- THREAD_COMPLETED: 线程完成
- THREAD_FAILED: 线程失败
- THREAD_PAUSED: 线程暂停
- THREAD_RESUMED: 线程恢复
- THREAD_FORKED: 线程分叉
- THREAD_JOINED: 线程合并

### 节点事件
- NODE_STARTED: 节点开始
- NODE_COMPLETED: 节点完成
- NODE_FAILED: 节点失败

### 工具事件
- TOOL_CALLED: 工具调用
- TOOL_COMPLETED: 工具完成
- TOOL_FAILED: 工具失败

### 系统事件
- ERROR: 错误事件
- CHECKPOINT_CREATED: 检查点创建

## 错误处理

### 监听器执行错误
- 捕获监听器执行过程中的错误
- 记录错误日志
- 不影响其他监听器的执行
- 继续执行后续监听器

### 事件触发错误
- 如果事件对象无效，抛出 Error
- 如果监听器不存在，静默处理

### 超时错误
- 如果 waitFor 超时，抛出 TimeoutError
- 自动注销监听器

## 注意事项

1. **异步处理**：支持异步监听器，使用 Promise.all 等待所有监听器完成
2. **错误隔离**：监听器错误不影响其他监听器
3. **内存管理**：及时清理不再需要的监听器
4. **性能优化**：避免在监听器中执行耗时操作
5. **线程安全**：确保事件分发的原子性