# message-processor.ts - 消息处理器逻辑设计

## 需求分析

消息处理器需要提供以下核心能力：
1. 处理消息模板渲染
2. 支持变量替换
3. 提供消息验证功能

这是一个轻量级的工具类，专注于消息处理，不涉及历史管理、序列化和Token统计。

## 核心职责

1. 模板渲染
2. 变量替换
3. 消息验证

## 主要方法逻辑

### 1. renderTemplate方法 - 渲染模板

接收模板字符串和变量对象，将模板中的变量占位符替换为实际值。

模板语法：
- 使用双花括号表示变量，如 {{variable_name}}
- 支持嵌套变量，如 {{user.name}}
- 支持默认值，如 {{variable_name|default_value}}
- 支持条件表达式，如 {{#if condition}}...{{/if}}
- 支持循环，如 {{#each array}}...{{/each}}

执行步骤：

步骤1：解析模板字符串
- 使用正则表达式查找所有双花括号包裹的内容
- 正则表达式模式：\{\{([^}]+)\}\}
- 提取所有匹配的内容

步骤2：处理每个占位符
- 对每个匹配的占位符：
  - 去除花括号，获取变量表达式
  - 去除首尾空格
  - 检查是否包含竖线（默认值分隔符）
  - 如果包含竖线，分割为变量名和默认值
  - 如果不包含竖线，默认值为空字符串

步骤3：获取变量值
- 从变量对象中查找变量名
- 如果变量名包含点号（嵌套变量），逐层查找
- 例如：user.name，先查找user，再查找name
- 如果找不到变量值，使用默认值
- 如果默认值也不存在，使用空字符串

步骤4：替换占位符
- 将模板中的占位符替换为实际值
- 如果值为对象或数组，转换为JSON字符串
- 如果值为null或undefined，转换为空字符串

步骤5：返回渲染结果
- 返回替换后的字符串

### 2. parseVariables方法 - 解析变量

从模板字符串中提取所有变量名。

执行步骤：

步骤1：使用正则表达式匹配
- 正则表达式模式：\{\{([^}|]+)(?:\|([^}]*))?\}\}
- 匹配双花括号包裹的内容
- 捕获组1：变量名（不包含竖线和默认值）
- 捕获组2：默认值（可选）

步骤2：提取变量名
- 遍历所有匹配结果
- 提取捕获组1的内容
- 去除首尾空格
- 添加到变量名数组

步骤3：去重
- 使用Set去除重复的变量名
- 转换为数组

步骤4：返回变量名数组
- 返回去重后的变量名数组

### 3. validateVariables方法 - 验证变量

检查变量对象是否包含模板所需的所有变量。

执行步骤：

步骤1：解析模板获取所有必需变量
- 调用parseVariables方法
- 获取所有变量名

步骤2：检查每个变量
- 遍历所有变量名
- 从变量对象中查找变量
- 如果变量不存在，添加到缺失变量列表

步骤3：返回验证结果
- 如果缺失变量列表为空，返回true
- 如果缺失变量列表不为空，返回false和缺失变量列表

### 4. renderMessage方法 - 渲染消息

接收消息模板和变量对象，返回完整的消息对象。

执行步骤：

步骤1：创建消息对象副本
- 复制消息模板的所有属性
- 创建新的消息对象

步骤2：处理消息内容
- 检查消息内容的类型
- 如果是字符串：
  - 调用renderTemplate方法
  - 传入消息内容和变量对象
  - 将渲染结果设置为消息内容
- 如果是数组：
  - 遍历数组中的每个元素
  - 如果元素是字符串，调用renderTemplate方法
  - 如果元素是对象，递归处理对象的每个属性
  - 将处理后的元素添加到新数组
  - 将新数组设置为消息内容

步骤3：处理工具调用
- 如果消息包含toolCalls属性：
  - 遍历每个工具调用
  - 处理工具调用的参数
  - 如果参数是字符串，调用renderTemplate方法
  - 如果参数是对象，递归处理对象的每个属性

步骤4：返回渲染后的消息对象
- 返回完整的消息对象

### 5. validateMessage方法 - 验证消息

验证消息对象的格式是否正确。

执行步骤：

步骤1：验证消息角色
- 检查role属性是否存在
- 检查role是否为有效值（system、user、assistant、tool）
- 如果无效，返回验证失败和错误信息

步骤2：验证消息内容
- 检查content属性是否存在
- 检查content是否为字符串或数组
- 如果无效，返回验证失败和错误信息

步骤3：验证工具调用
- 如果role为assistant：
  - 检查toolCalls属性是否存在
  - 如果存在，验证toolCalls是否为数组
  - 遍历每个toolCall：
    - 检查id属性是否存在
    - 检查type属性是否为function
    - 检查function属性是否存在
    - 检查function.name是否存在
    - 检查function.arguments是否存在

步骤4：验证工具调用ID
- 如果role为tool：
  - 检查toolCallId属性是否存在
  - 检查toolCallId是否为字符串

步骤5：返回验证结果
- 如果所有验证都通过，返回true
- 如果有验证失败，返回false和错误信息数组

## 错误处理

1. 模板渲染失败：返回原始模板，记录错误
2. 变量缺失：使用默认值或抛出异常
3. 消息验证失败：返回详细的错误信息

## 性能考虑

1. 模板解析结果可以缓存，避免重复解析
2. 变量查找使用缓存，提高性能

## 扩展点

1. 自定义模板语法
2. 自定义变量解析器
3. 自定义验证规则

## 使用场景

1. 在Conversation中使用：渲染模板消息
2. 在LLM节点中使用：处理节点配置中的消息
3. 在应用层中使用：自定义消息处理逻辑

## 注意事项

1. 模板渲染可能会失败，需要妥善处理
2. 变量替换可能会改变消息语义
3. 不涉及序列化和Token统计，这些功能由其他模块提供