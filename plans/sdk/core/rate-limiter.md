# 限流器设计

## 文件位置
`sdk/core/http/rate-limiter.ts`

## 设计目标
使用令牌桶算法限制请求速率，防止API调用超限，避免被服务端拒绝。

## 核心职责
- 管理令牌桶
- 按固定速率填充令牌
- 等待可用令牌
- 提供令牌使用统计

## 构造函数
接收配置对象，包含：
- capacity：令牌桶容量
- refillRate：填充速率（每秒填充的令牌数）

## 公开方法

### waitForToken方法
等待可用令牌。
执行步骤：
1. 进入无限循环
2. 调用refill填充令牌
3. 检查tokens是否大于等于1
4. 如果有可用令牌：
   - tokens减1
   - 返回（结束等待）
5. 如果没有可用令牌：
   - 调用calculateWaitTime计算等待时间
   - 调用sleep等待指定时间
   - 继续循环

### getAvailableTokens方法
获取可用令牌数。
执行步骤：
1. 调用refill填充令牌
2. 返回当前tokens数量

### reset方法
重置限流器。
执行步骤：
1. 将tokens设置为capacity
2. 将lastRefill设置为当前时间

## 私有方法

### refill方法
填充令牌。
执行步骤：
1. 获取当前时间
2. 计算距离上次填充的时间差（转换为秒）
3. 计算应该添加的令牌数：时间差乘以填充速率
4. 将tokens设置为当前tokens和添加令牌数之和，但不能超过capacity
5. 更新lastRefill为当前时间

### calculateWaitTime方法
计算等待时间。
执行步骤：
1. 计算需要的令牌数：1
2. 计算令牌缺口：需要的令牌数减去当前tokens
3. 计算等待时间：令牌缺口除以填充速率，转换为毫秒
4. 向上取整并返回

### sleep方法
延迟指定时间。
执行步骤：
1. 返回一个Promise，在指定时间后resolve

## 设计要点
- 使用令牌桶算法，平滑限流
- 按固定速率填充令牌，避免突发流量
- waitForToken会阻塞直到有可用令牌
- 令牌不会超过容量上限
- 支持动态调整容量和填充速率
- 适用于API调用限流场景