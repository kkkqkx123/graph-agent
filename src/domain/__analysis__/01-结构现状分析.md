# src\domain 目录结构现状分析

## 概述

当前 `src\domain` 目录存在多种不同的组织结构，反映了框架演进过程中的不同阶段和设计理念。本报告详细分析了各模块的结构特点和组织模式。

## 当前目录结构

```
src/domain/
├── common/                          # 通用领域组件
│   ├── base/                        # 基础类
│   ├── errors/                      # 错误处理
│   ├── events/                      # 事件系统
│   ├── repositories/                # 仓储接口
│   ├── types/                       # 类型定义
│   ├── utils/                       # 工具类
│   └── value-objects/               # 值对象
├── checkpoint/                      # 检查点模块
│   ├── entities/                    # 实体
│   ├── repositories/                # 仓储接口
│   ├── services/                    # 领域服务
│   └── value-objects/               # 值对象
├── history/                         # 历史记录模块
│   ├── entities/                    # 实体
│   ├── repositories/                # 仓储接口
│   ├── services/                    # 领域服务
│   └── value-objects/               # 值对象
├── llm/                             # LLM模块
│   ├── entities/                    # 实体
│   ├── exceptions/                  # 异常定义
│   ├── interfaces/                  # 接口定义
│   ├── repositories/                # 仓储接口（混合实现）
│   ├── types/                       # 类型定义
│   └── value-objects/               # 值对象
├── prompts/                         # 提示词模块
│   ├── entities/                    # 实体
│   └── value-objects/               # 值对象
├── sessions/                        # 会话模块
│   ├── entities/                    # 实体
│   ├── events/                      # 事件
│   ├── repositories/                # 仓储接口
│   └── services/                    # 领域服务
├── threads/                         # 线程模块
│   ├── checkpoints/                 # 子模块：检查点
│   │   ├── entities/                # 实体
│   │   ├── repositories/            # 仓储接口
│   │   ├── services/                # 领域服务
│   │   └── value-objects/           # 值对象
│   ├── entities/                    # 实体
│   ├── events/                      # 事件
│   ├── repositories/                # 仓储接口
│   ├── services/                    # 领域服务
│   └── value-objects/               # 值对象
├── tools/                           # 工具模块
│   ├── entities/                    # 实体
│   ├── interfaces/                  # 接口定义
│   ├── repositories/                # 仓储接口（混合实现）
│   └── value-objects/               # 值对象
└── workflow/                        # 工作流模块
    ├── entities/                    # 实体
    ├── events/                      # 事件
    ├── repositories/                # 仓储接口
    ├── services/                    # 领域服务
    ├── state/                       # 状态管理
    ├── strategies/                  # 策略模式
    └── value-objects/               # 值对象
```

## 结构模式分类

### 模式A：标准DDD分层结构（5个模块）

**采用模块**：`checkpoint`, `history`, `sessions`, `threads`

**结构特点**：
```
module/
├── entities/          # 实体类
├── repositories/      # 仓储接口
├── services/          # 领域服务
└── value-objects/     # 值对象
```

**优点**：
- 符合经典DDD分层架构
- 职责清晰，易于理解
- 适合业务逻辑复杂的模块

**缺点**：
- 对于简单模块可能过于繁琐
- 目录层级较深

---

### 模式B：接口分离结构（2个模块）

**采用模块**：`llm`, `tools`

**结构特点**：
```
module/
├── entities/          # 实体类
├── interfaces/        # 接口定义
├── repositories/      # 仓储接口（混合）
├── types/             # 类型定义
├── exceptions/        # 异常定义
└── value-objects/     # 值对象
```

**特点**：
- 显式分离接口定义
- 包含异常定义目录
- 仓储接口存在混合实现（接口+实现）

**优点**：
- 接口契约清晰
- 适合需要多实现的模块
- 异常处理规范

**缺点**：
- 与架构规范冲突（接口应在domain层定义）
- repositories目录职责不纯

---

### 模式C：最小化结构（1个模块）

**采用模块**：`prompts`

**结构特点**：
```
module/
├── entities/          # 实体类
└── value-objects/     # 值对象
```

**优点**：
- 简洁明了
- 适合简单CRUD模块
- 开发效率高

**缺点**：
- 扩展性有限
- 业务复杂时可能需要重构

---

### 模式D：嵌套子模块结构（1个模块）

**采用模块**：`threads`

**特殊结构**：
```
threads/
├── checkpoints/       # 子模块：线程检查点
│   ├── entities/
│   ├── repositories/
│   ├── services/
│   └── value-objects/
└── ...（标准结构）
```

**优点**：
- 模块内聚性高
- 避免顶层目录过多
- 适合强关联的子领域

**缺点**：
- 结构复杂度高
- 可能违反单一职责原则

---

### 模式E：通用基础结构（1个模块）

**采用模块**：`common`

**结构特点**：
```
common/
├── base/              # 基础类（Entity等）
├── errors/            # 错误处理
├── events/            # 事件系统
├── repositories/      # 基础仓储接口
├── types/             # 通用类型
├── utils/             # 工具类
└── value-objects/     # 通用值对象
```

**特点**：
- 提供框架级基础能力
- 被所有其他模块依赖
- 包含技术基础设施

---

## 结构统计对比

| 模块 | 模式 | 子目录数 | 文件数 | 复杂度 | 规范符合度 |
|------|------|----------|--------|--------|------------|
| common | E | 7 | 25+ | 高 | 部分符合 |
| checkpoint | A | 4 | 12 | 中 | 符合 |
| history | A | 4 | 18 | 中 | 符合 |
| llm | B | 6 | 20+ | 高 | 不符合 |
| prompts | C | 2 | 6 | 低 | 基本符合 |
| sessions | A | 4 | 12 | 中 | 符合 |
| threads | D | 5+ | 20+ | 高 | 部分符合 |
| tools | B | 4 | 12 | 中 | 不符合 |
| workflow | A+ | 6 | 18 | 中 | 符合 |

**注**：workflow在模式A基础上增加了`state/`和`strategies/`

## 关键发现

### 1. 结构多样性
- 9个模块采用了5种不同的组织模式
- 缺乏统一的结构规范
- 新模块开发时无明确指导

### 2. 规范违反点
- `llm/repositories/` 和 `tools/repositories/` 包含实现代码
- 部分接口定义散落在不同位置
- 子模块嵌套深度不一致

### 3. 演进痕迹明显
- `common`模块承担了过多技术职责
- `llm`模块保留了早期设计痕迹
- `threads/checkpoints`显示领域边界调整

### 4. 复杂度分布不均
- 模块复杂度从低到高分布广泛
- 简单模块（prompts）和复杂模块（llm）结构差异大
- 缺乏基于复杂度的结构分级策略

## 结论

当前结构反映了框架从简单到复杂的演进过程，但缺乏统一规范导致：

1. **学习成本高**：开发者需要理解多种结构模式
2. **维护困难**：不同模块采用不同组织方式
3. **扩展性差**：新模块开发缺乏明确指导
4. **规范冲突**：部分实现违反分层架构原则

需要制定统一的结构规范，并根据模块复杂度提供分级指导。