# 模块分类与重构方案

## 当前模块复杂度评估

### 模块复杂度评分标准

| 维度 | 权重 | 评分标准 |
|------|------|----------|
| 实体数量 | 30% | 1-3个(1分), 4-6个(2分), 7+个(3分) |
| 业务规则复杂度 | 25% | 简单CRUD(1分), 中等逻辑(2分), 复杂规则(3分) |
| 依赖关系 | 20% | 无依赖(1分), 模块内依赖(2分), 跨模块依赖(3分) |
| 状态管理 | 15% | 无状态(1分), 简单状态(2分), 复杂状态机(3分) |
| 事件驱动 | 10% | 无事件(1分), 简单事件(2分), 复杂事件流(3分) |

### 各模块评分结果

| 模块 | 实体数 | 业务复杂度 | 依赖关系 | 状态管理 | 事件驱动 | 总分 | 推荐级别 |
|------|--------|------------|----------|----------|----------|------|----------|
| prompts | 1 | 1 | 1 | 1 | 1 | 1.0 | Level 1 |
| checkpoint | 1 | 2 | 1 | 2 | 1 | 1.55 | Level 2 |
| sessions | 1 | 2 | 1 | 2 | 2 | 1.7 | Level 2 |
| history | 1 | 3 | 1 | 2 | 2 | 2.05 | Level 2 |
| threads | 2 | 2 | 2 | 2 | 2 | 1.9 | Level 2 |
| tools | 3 | 2 | 1 | 2 | 1 | 1.75 | Level 2 |
| workflow | 3 | 3 | 1 | 3 | 2 | 2.4 | Level 3 |
| llm | 4 | 3 | 2 | 3 | 2 | 2.65 | Level 3 |
| common | 8+ | 2 | 1 | 1 | 1 | 2.15 | 特殊处理 |

---

## 模块分类与适用结构

### 🟢 Level 1：极简结构（1个模块）

#### prompts 模块
**当前问题**：
- 结构不完整，缺少必要组件
- 实体定义过于简单

**重构方案**：
```
prompts/
├── index.ts
├── entities/
│   ├── index.ts
│   └── prompt.ts          # 完善实体定义
└── value-objects/
    ├── index.ts
    ├── prompt-id.ts       # 已存在
    ├── prompt-type.ts     # 已存在
    └── prompt-status.ts   # 已存在
```

**具体改进**：
1. **完善实体定义**：
```typescript
// entities/prompt.ts
export class Prompt extends Entity {
  private readonly props: PromptProps
  
  private constructor(props: PromptProps) {
    super(props.id, props.createdAt, props.updatedAt, props.version)
    this.props = Object.freeze(props)
  }
  
  static create(props: CreatePromptProps): Prompt {
    // 验证逻辑
    return new Prompt({
      ...props,
      id: PromptId.create(),
      createdAt: Timestamp.now(),
      updatedAt: Timestamp.now(),
      version: Version.initial()
    })
  }
  
  // 业务方法
  activate(): void {
    if (this.props.status === PromptStatus.ACTIVE) {
      throw new DomainError('Prompt is already active')
    }
    // 状态转换逻辑
  }
}
```

2. **评估是否需要升级**：
- 如果prompts需要复杂管理，考虑升级到Level 2
- 添加仓储接口和服务类

---

### 🟡 Level 2：标准结构（5个模块）

#### 1. checkpoint 模块
**当前状态**：基本符合Level 2，需要微调

**优化方案**：
```
checkpoint/
├── index.ts
├── entities/
│   ├── index.ts
│   └── checkpoint.ts    # 保持现有实现
├── value-objects/
│   ├── index.ts
│   ├── checkpoint-id.ts
│   └── checkpoint-type.ts
└── repositories/
    ├── index.ts
    └── checkpoint-repository.ts
```

**改进要点**：
1. 确保实体继承自 `Entity` 基类
2. 验证业务规则完整性
3. 完善仓储接口定义

#### 2. sessions 模块
**当前状态**：结构良好，需要标准化

**标准化方案**：
```
sessions/
├── index.ts
├── entities/
│   ├── index.ts
│   └── session.ts
├── value-objects/
│   ├── index.ts
│   ├── session-id.ts
│   ├── session-status.ts
│   └── session-config.ts
├── services/
│   ├── index.ts
│   └── session-domain-service.ts
├── repositories/
│   ├── index.ts
│   └── session-repository.ts
└── events/
    ├── index.ts
    ├── session-created-event.ts
    └── session-status-changed-event.ts
```

**标准化要点**：
1. 统一事件命名规范
2. 确保服务类只依赖领域接口
3. 验证实体业务方法完整性

#### 3. history 模块
**当前状态**：服务类过多，需要合并优化

**优化方案**：
```
history/
├── index.ts
├── entities/
│   ├── index.ts
│   └── history.ts
├── value-objects/
│   ├── index.ts
│   └── history-type.ts
├── services/
│   ├── index.ts
│   ├── history-service.ts           # 合并通用服务
│   ├── execution-history-service.ts  # 保留专用服务
│   └── session-history-service.ts    # 保留专用服务
└── repositories/
    ├── index.ts
    └── history-repository.ts
```

**合并策略**：
1. **通用历史服务**：处理所有历史记录的通用逻辑
2. **专用服务**：保留特定场景的服务类
3. **删除冗余服务**：合并功能重复的服务

#### 4. threads 模块
**当前状态**：结构复杂，需要简化

**简化方案**：
**选项A：保持现有结构，优化子模块**
```
threads/
├── index.ts
├── entities/
├── value-objects/
├── services/
├── repositories/
├── events/
└── checkpoints/           # 作为子模块保留
    ├── index.ts
    ├── entities/
    ├── value-objects/
    ├── services/
    └── repositories/
```

**选项B：拆分为独立模块（推荐）**
```
threads/                   # 线程模块
├── index.ts
├── entities/
├── value-objects/
├── services/
├── repositories/
└── events/

thread-checkpoints/        # 独立模块
├── index.ts
├── entities/
├── value-objects/
├── services/
└── repositories/
```

**推荐理由**：
- 线程和检查点是两个独立的概念
- 降低模块耦合度
- 提高代码可维护性
- 符合单一职责原则

#### 5. tools 模块
**当前状态**：接口分离，需要合并

**重构方案**：
```
tools/
├── index.ts
├── entities/
│   ├── index.ts
│   ├── tool.ts
│   ├── tool-execution.ts
│   └── tool-result.ts
├── value-objects/
│   ├── index.ts
│   ├── tool-status.ts
│   └── tool-execution-status.ts
├── services/
│   ├── index.ts
│   └── tool-domain-service.ts
└── repositories/
    ├── index.ts
    ├── tool-repository.ts
    ├── tool-execution-repository.ts
    └── tool-result-repository.ts
```

**重构要点**：
1. **合并接口定义**：移除独立的 `interfaces/` 目录
2. **清理仓储接口**：确保只有接口定义，无实现
3. **标准化命名**：统一使用工具相关的命名

---

### 🔴 Level 3：完整结构（2个模块）

#### 1. workflow 模块
**当前状态**：结构良好，接近Level 3标准

**完善方案**：
```
workflow/
├── index.ts
├── entities/
│   ├── index.ts
│   └── workflow.ts
├── value-objects/
│   ├── index.ts
│   ├── workflow-id.ts
│   ├── node-id.ts
│   ├── edge-id.ts
│   ├── node-type.ts
│   └── edge-type.ts
├── services/
│   ├── index.ts
│   ├── workflow-service.ts
│   ├── workflow-execution-service.ts
│   └── workflow-orchestration-service.ts
├── repositories/
│   ├── index.ts
│   └── workflow-repository.ts
├── events/
│   ├── index.ts
│   ├── workflow-created-event.ts
│   ├── workflow-status-changed-event.ts
│   ├── node-added-event.ts
│   └── edge-added-event.ts
├── state/
│   ├── index.ts
│   └── workflow-state.ts
└── strategies/
    ├── index.ts
    └── execution-strategy.ts
```

**完善要点**：
1. **验证状态管理**：确保状态转换逻辑完整
2. **优化策略模式**：评估是否需要更多策略类
3. **事件完整性**：确保覆盖所有重要业务事件

#### 2. llm 模块
**当前状态**：最复杂，需要大幅重构

**重构方案**：
```
llm/
├── index.ts
├── entities/
│   ├── index.ts
│   ├── llm-request.ts
│   ├── llm-response.ts
│   ├── pool.ts
│   ├── task-group.ts
│   └── wrapper.ts
├── value-objects/
│   ├── index.ts
│   ├── model-config.ts
│   ├── pool-instance.ts
│   ├── prompt-template.ts
│   ├── rotation-strategy.ts
│   └── echelon.ts
├── services/
│   ├── index.ts
│   ├── llm-domain-service.ts
│   ├── pool-service.ts
│   └── task-group-service.ts
├── repositories/
│   ├── index.ts
│   ├── llm-request-repository.ts
│   └── llm-response-repository.ts
├── exceptions/
│   ├── index.ts
│   ├── pool-exceptions.ts
│   └── task-group-exceptions.ts
└── types/
    ├── index.ts
│   └── llm-types.ts
```

**重构要点**：
1. **清理接口重复**：合并重复的仓储接口定义
2. **分离技术实现**：将具体实现移到基础设施层
3. **标准化异常处理**：统一异常定义和使用
4. **优化类型定义**：确保类型定义清晰且必要

---

### ⚫ common 模块特殊处理

**问题分析**：
- 承担了过多技术职责
- 模块过于庞大
- 违反了领域层原则

**重构方案**：

#### 方案A：保持现有结构，职责分离
```
common/                    # 仅保留纯领域概念
├── index.ts
├── base/                  # 基础领域概念
├── errors/               # 领域错误定义
├── events/               # 领域事件
├── types/                # 领域类型
└── value-objects/        # 通用值对象

// 新增技术基础设施模块
infrastructure/
├── utils/                # 技术工具类
├── error-handlers/       # 错误处理实现
└── event-dispatchers/    # 事件分发实现
```

#### 方案B：拆分为多个专业模块
```
domain-core/              # 核心领域概念
├── entities/
├── value-objects/
└── errors/

domain-events/            # 事件系统
events/
├── domain-event.ts
└── event-dispatcher.ts

domain-types/             # 通用类型
types/
├── common-types.ts
└── config-types.ts
```

**推荐方案**：方案A，因为：
- 改动最小，风险最低
- 保持了向后兼容性
- 清晰分离了技术和业务职责

---

## 重构实施计划

### 第一阶段：准备和试点（2周）

#### Week 1：准备工作
- **Day 1-2**：制定详细重构计划
- **Day 3-4**：准备测试用例和验证方案
- **Day 5**：团队培训和规范宣导

#### Week 2：试点模块
- **Day 1-3**：重构 `prompts` 模块（Level 1）
- **Day 4-5**：重构 `checkpoint` 模块（Level 2）
- **验证**：确保试点模块功能正常

### 第二阶段：批量重构（6周）

#### Week 3-4：Level 2 模块
- **sessions**：标准化事件和服务
- **history**：合并服务类
- **tools**：清理接口重复

#### Week 5-6：复杂模块预处理
- **threads**：评估拆分方案
- **workflow**：完善Level 3结构
- **common**：分离技术职责

#### Week 7-8：核心模块重构
- **llm**：大幅重构，清理接口
- **threads**：实施拆分或优化
- **common**：完成职责分离

### 第三阶段：验证和优化（2周）

#### Week 9：全面测试
- 单元测试覆盖率验证
- 集成测试回归验证
- 性能基准测试

#### Week 10：文档和工具
- 更新开发文档
- 完善代码生成工具
- 建立自动化检查机制

---

## 风险评估与应对

### 高风险项

#### 1. llm 模块重构
- **风险**：业务逻辑复杂，容易出错
- **影响**：核心功能受影响
- **应对**：
  - 充分的前期分析
  - 分步骤小批量重构
  - 完整的回归测试

#### 2. common 模块职责分离
- **风险**：影响面广，依赖多
- **影响**：所有模块可能受影响
- **应对**：
  - 保持接口兼容性
  - 渐进式迁移
  - 提供迁移指南

#### 3. threads 模块拆分
- **风险**：模块边界重新定义
- **影响**：业务流程可能变化
- **应对**：
  - 仔细评估业务边界
  - 与业务专家确认
  - 小范围试点验证

### 中等风险项

#### 1. history 服务合并
- **风险**：服务职责重新划分
- **应对**：保持现有接口，内部重构

#### 2. 接口定义统一
- **风险**：大量文件需要修改
- **应对**：使用自动化工具批量处理

### 低风险项

#### 1. 文件命名标准化
- **风险**：纯命名变更，不影响逻辑
- **应对**：批量重命名工具

#### 2. 目录结构调整
- **风险**：结构变更，逻辑不变
- **应对**：IDE批量移动，自动更新引用

---

## 验证标准

### 功能验证
- [ ] 所有现有测试用例通过
- [ ] 核心业务流程正常
- [ ] API接口保持不变
- [ ] 数据格式兼容

### 结构验证
- [ ] 目录结构符合规范
- [ ] 文件命名统一
- [ ] 无重复接口定义
- [ ] 职责分离清晰

### 质量验证
- [ ] 代码复杂度降低
- [ ] 模块耦合度降低
- [ ] 代码可读性提升
- [ ] 维护成本降低

### 性能验证
- [ ] 启动时间无显著变化
- [ ] 内存使用无显著增加
- [ ] 响应时间无显著下降
- [ ] 并发性能无显著影响

---

## 成功指标

### 短期指标（1个月内）
- 重构模块数量：9个（100%）
- 测试通过率：100%
- 代码规范符合率：>95%
- 团队满意度：>80%

### 长期指标（3个月后）
- 代码维护效率提升：>30%
- 新功能开发速度提升：>20%
- 缺陷率降低：>15%
- 代码审查效率提升：>25%

通过系统性的重构实施，将显著提升框架的可维护性、可扩展性和团队协作效率，为长期发展奠定坚实基础。